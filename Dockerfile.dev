# Dockerfile
FROM ruby:3.4.5-slim

# 必要なパッケージをインストール
RUN apt update -qq && \
    apt install --no-install-recommends -y curl default-mysql-client libjemalloc2 libvips build-essential default-libmysqlclient-dev libyaml-dev && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# ユーザーを作成（デフォルト値、build時に上書き可能）
ARG USER_ID=1000
ARG GROUP_ID=1000

# グループとユーザーを作成
RUN groupadd -g $GROUP_ID appuser && \
    useradd -m -u $USER_ID -g $GROUP_ID -s /bin/bash appuser

# 作業ディレクトリを設定
WORKDIR /app

# appuserに所有権を変更
RUN chown -R appuser:appuser /app

# GemfileとGemfile.lockをコピー
COPY Gemfile Gemfile.lock  ./

# gemをインストール
RUN bundle install

# ソースコードをコピー
COPY . .

# 所有権をappuserに変更
RUN chown -R appuser:appuser /app

# appuserに切り替え
USER appuser

# ポートを指定
EXPOSE 3000
